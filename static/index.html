<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë¥´ë‹¤ - ì˜¤ëŠ˜ì˜ ì´ìŠˆ</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page.css">
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">ì˜¤ë¥´ë‹¤</div>
                <div class="logo-subtitle">íˆ¬ì í•™ìŠµ í”Œë«í¼</div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="navigateTo('home')"><span class="nav-icon">ğŸ </span><span>Home</span></div>
                <div class="nav-item" onclick="navigateTo('news')"><span class="nav-icon">ğŸ“°</span><span>News</span></div>
                <div class="nav-item" onclick="navigateTo('sector')"><span class="nav-icon">ğŸ­</span><span>Sector</span></div>
                <div class="nav-item" onclick="navigateTo('company')"><span class="nav-icon">ğŸ¢</span><span>Company</span></div>
                <div class="nav-item" onclick="navigateTo('mock-invest')"><span class="nav-icon">ğŸ“ˆ</span><span>Mock Invest</span></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page-header home-header">
                <div class="welcome-text">íˆ¬ì í•™ìŠµì˜ ì‹œì‘</div>
                <h1 class="page-title">ì˜¤ëŠ˜ì˜ ì´ìŠˆ</h1>
                <p class="page-subtitle">AIê°€ ì„ ë³„í•œ ì£¼ì‹ì‹œì¥ ê´€ë ¨ í•µì‹¬ ì´ìŠˆë“¤ì„<br>ë¶„ì„í•˜ì—¬ íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì–´ë³´ì„¸ìš”</p>
                <div class="today-date" id="today-date"></div>
            </div>
            
            <div class="status-bar">
                <div class="status-info">
                    <div class="status-item"><div class="status-indicator"></div><span>AI RAG ë¶„ì„ í™œì„±í™”</span></div>
                    <div class="status-item"><span>ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update-time"></span></span></div>
                    <div class="status-item"><span>ğŸ“Š AI ì„ ë³„ <span id="issue-count">0</span>ê°œ ì´ìŠˆ</span></div>
                </div>
                <button id="refresh-issues-btn" class="btn btn-primary" style="padding: 0.5rem 1rem;">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            </div>
            
            <div class="issues-section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ¯ AI ì„ ë³„ ì£¼ìš” ì´ìŠˆ (<span id="grid-issue-count">0</span>ê°œ)</h2>
                </div>
                <div class="issues-grid" id="issues-grid"></div>
            </div>
        </div>
    </div>
    
    <div id="ai-analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeAIAnalysisModal()" class="modal-close-btn">&times;</button>
            <h2 id="modal-issue-title" class="modal-title"></h2>
            <div id="modal-issue-score" class="modal-score-bar">
                <strong>ğŸ“Š ì£¼ì‹ì‹œì¥ ê´€ë ¨ì„± ì ìˆ˜: <span id="score-value">N/A</span>/10</strong>
                <span class="rag-confidence">ğŸ” RAG ë¶„ì„ ì‹ ë¢°ë„: <span id="rag-confidence">N/A</span></span>
            </div>
            <div class="modal-section">
                <h3 class="modal-section-title">ğŸ“ ì›ë³¸ ì´ìŠˆ ë‚´ìš©</h3>
                <div id="modal-issue-content" class="modal-text-box scrollable"></div>
            </div>
            <div class="modal-section">
                <h3 class="modal-section-title green">ğŸ’¡ RAG ì¢…í•© ë¶„ì„</h3>
                <div id="modal-rag-summary" class="modal-highlight-box green"></div>
            </div>
            <div class="modal-grid">
                <div class="modal-section">
                    <h3 class="modal-section-title red">ğŸ­ ê´€ë ¨ ì‚°ì—… ë¶„ì„</h3>
                    <div id="modal-related-industries" class="modal-highlight-box red"></div>
                </div>
                <div class="modal-section">
                    <h3 class="modal-section-title blue">ğŸ“š ê´€ë ¨ ê³¼ê±° ì´ìŠˆ</h3>
                    <div id="modal-related-past-issues" class="modal-highlight-box blue"></div>
                </div>
            </div>
            <div class="modal-footer">
                <strong>ë¶„ì„ ì •ë³´:</strong> 
                <span>ë²¡í„° ê²€ìƒ‰ + GPT-4o-mini</span> | 
                <span id="analysis-timestamp"></span>
            </div>
        </div>
    </div>

    <script>
        let currentIssues = [];
        let isRefreshing = false;

        document.addEventListener('DOMContentLoaded', () => {
            updateTodayDate();
            loadCurrentIssues();
            setupRefreshButton();
        });

        function updateTodayDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', options);
            document.getElementById('last-update-time').textContent = today.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        async function loadCurrentIssues() {
            const grid = document.getElementById('issues-grid');
            grid.innerHTML = `<div class="loading"><div class="spinner"></div><p>ìµœì‹  RAG ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;

            try {
                // âœ… ìˆ˜ì •: ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                const response = await fetch('/api/news/latest');
                if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                
                const result = await response.json();
                
                // âœ… ìˆ˜ì •: ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ë°ì´í„° ì¶”ì¶œ
                if (!result.success || !result.data.issues) {
                    throw new Error("ì²˜ë¦¬ëœ ì´ìŠˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
                
                currentIssues = result.data.issues;
                displayIssues(currentIssues);
                updateIssueCounts(currentIssues.length);
                
                // âœ… ìˆ˜ì •: ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ
                const source = result.data.source || 'ë°ì´í„°ë² ì´ìŠ¤';
                showNotification(`âœ… ${currentIssues.length}ê°œ ìµœì‹  ì´ìŠˆ ë¡œë“œ ì™„ë£Œ! (ì¶œì²˜: ${source})`, 'success');

            } catch (error) {
                console.error('âŒ ì´ìŠˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                grid.innerHTML = `<div class="loading"><p class="error-text">${error.message}</p><p>ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p></div>`;
                showNotification('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function displayIssues(issues) {
            const grid = document.getElementById('issues-grid');
            grid.innerHTML = '';
            issues.forEach((issue, index) => {
                const card = document.createElement('div');
                card.className = 'issue-card';
                card.onclick = () => showAIAnalysisModal(index);
                
                // âœ… ìˆ˜ì •: MySQL ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ í•„ë“œëª… ìˆ˜ì •
                const score = issue.stock_relevance_score || issue.ì£¼ì‹ì‹œì¥_ê´€ë ¨ì„±_ì ìˆ˜ || 0;
                const rank = issue.ranking || issue.rank || (index + 1);
                
                card.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-rank">TOP ${rank}</div>
                        <div class="issue-score" style="background-color: ${getScoreColor(score)};">${score.toFixed(1)}</div>
                    </div>
                    <div class="issue-title">${issue.title || issue.ì œëª©}</div>
                    <div class="issue-summary">${
                        issue.ë¶„ì„ê·¼ê±° || 
                        (issue.content ? issue.content.substring(0, 100) + '...' : '') ||
                        (issue.ë‚´ìš© ? issue.ë‚´ìš©.substring(0, 100) + '...' : '')
                    }</div>
                `;
                grid.appendChild(card);
            });
        }
        
        function setupRefreshButton() {
            const refreshBtn = document.getElementById('refresh-issues-btn');
            refreshBtn.addEventListener('click', async () => {
                if (isRefreshing) return;
                
                isRefreshing = true;
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'ğŸ”„ ì²˜ë¦¬ ì¤‘...';
                showNotification('ğŸš€ ë°±ê·¸ë¼ìš´ë“œ íŒŒì´í”„ë¼ì¸ì„ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. 3~5ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
                
                try {
                    // âœ… ìˆ˜ì •: ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    const response = await fetch('/api/pipeline/trigger', { method: 'POST' });
                    if (!response.ok) throw new Error('íŒŒì´í”„ë¼ì¸ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message, 'success');
                        
                        // 3ë¶„(180ì´ˆ) í›„ ìƒˆ ë°ì´í„° ë¡œë“œ ì‹œë„
                        setTimeout(() => {
                            showNotification('ğŸ”„ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...', 'info');
                            loadCurrentIssues();
                        }, 180000);
                    } else {
                        throw new Error(result.message || 'íŒŒì´í”„ë¼ì¸ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                } catch (error) {
                    console.error('âŒ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                    showNotification(error.message, 'error');
                } finally {
                    // 3ë¶„ í›„ ë²„íŠ¼ í™œì„±í™”
                    setTimeout(() => {
                        isRefreshing = false;
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨';
                    }, 180000);
                }
            });
        }

        function showAIAnalysisModal(issueIndex) {
            const issue = currentIssues[issueIndex];
            if (!issue) return;

            // âœ… ìˆ˜ì •: MySQL ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ í•„ë“œëª… ìˆ˜ì •
            document.getElementById('modal-issue-title').textContent = issue.title || issue.ì œëª©;
            document.getElementById('modal-issue-content').textContent = issue.content || issue.ë‚´ìš© || 'ë‚´ìš© ì—†ìŒ';
            
            const score = issue.stock_relevance_score || issue.ì£¼ì‹ì‹œì¥_ê´€ë ¨ì„±_ì ìˆ˜ || 0;
            const ragConfidence = issue.rag_confidence || issue.RAGë¶„ì„ì‹ ë¢°ë„ || 'N/A';
            
            document.getElementById('score-value').textContent = score.toFixed(1);
            document.getElementById('rag-confidence').textContent = ragConfidence;
            
            // RAG ì¢…í•© ë¶„ì„ (í˜„ì¬ëŠ” ê¸°ë³¸ ë©”ì‹œì§€, ì¶”í›„ ë°±ì—”ë“œì—ì„œ ì¶”ê°€)
            const explanation = issue.explanation || issue.ë¶„ì„ê²°ê³¼ || 
                `ì´ ì´ìŠˆëŠ” ì£¼ì‹ì‹œì¥ ê´€ë ¨ì„± ì ìˆ˜ ${score.toFixed(1)}ì ìœ¼ë¡œ ì„ ë³„ë˜ì—ˆìŠµë‹ˆë‹¤. AI ë¶„ì„ì„ í†µí•´ ê´€ë ¨ ì‚°ì—…ê³¼ ê³¼ê±° ì´ìŠˆë¥¼ ë§¤ì¹­í•˜ì—¬ íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.`;
            
            document.getElementById('modal-rag-summary').innerHTML = explanation.replace(/\n/g, '<br>');
            
            // âœ… ìˆ˜ì •: MySQLì˜ related_industriesì™€ related_past_issues êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •
            document.getElementById('modal-related-industries').innerHTML = formatContextForModal(
                issue.related_industries || issue.ê´€ë ¨ì‚°ì—… || [], 'ì‚°ì—…'
            );
            document.getElementById('modal-related-past-issues').innerHTML = formatContextForModal(
                issue.related_past_issues || issue.ê´€ë ¨ê³¼ê±°ì´ìŠˆ || [], 'ê³¼ê±° ì´ìŠˆ'
            );

            const timestamp = issue.extracted_at || issue.ì¶”ì¶œì‹œê°„ || issue.updated_at || Date.now();
            document.getElementById('analysis-timestamp').textContent = 
                `ë¶„ì„ ì‹œê°„: ${new Date(timestamp).toLocaleString('ko-KR')}`;
            
            document.getElementById('ai-analysis-modal').style.display = 'flex';
        }

        function closeAIAnalysisModal() {
            document.getElementById('ai-analysis-modal').style.display = 'none';
        }

        function formatContextForModal(items, type) {
            if (!items || items.length === 0) {
                return `<div class="modal-no-data">ê´€ë ¨ ${type} ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
            
            // âœ… ìˆ˜ì •: MySQL ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ í•„ë“œëª… ìˆ˜ì •
            return items.map((item, idx) => {
                const title = item.industry_name || item.issue_name || item.name || 'ì´ë¦„ ì—†ìŒ';
                const description = item.description || item.ai_reason || item.reason || 'ì„¤ëª… ì—†ìŒ';
                const score = item.final_score ? ` (ì ìˆ˜: ${item.final_score})` : '';
                
                return `
                    <div class="modal-list-item">
                        <div class="modal-list-title">
                            ${idx + 1}. ${title}${score}
                        </div>
                        <div class="modal-list-desc">${description.substring(0, 150)}...</div>
                    </div>
                `;
            }).join('');
        }

        function getScoreColor(score) {
            if (score >= 8.5) return '#dc3545';
            if (score >= 7.0) return '#ffc107';
            return '#28a745';
        }

        function updateIssueCounts(count) {
            document.getElementById('issue-count').textContent = count;
            document.getElementById('grid-issue-count').textContent = count;
        }

        function navigateTo(page) {
            const pages = {
                'home': '/static/index.html',
                'news': '/static/news.html', 
                'sector': '/static/sector.html',
                'company': '/static/company.html',
                'mock-invest': '/static/mock-invest.html'
            };
            if (window.location.pathname !== pages[page]) {
                window.location.href = pages[page];
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'linear-gradient(135deg, #28a745, #218838)',
                error: 'linear-gradient(135deg, #dc3545, #c82333)',
                info: 'linear-gradient(135deg, #17a2b8, #138496)'
            };
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">&times;</button>`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 5000);
        }
    </script>
</body>
</html>