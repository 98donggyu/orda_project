<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë¥´ë‹¤ - ë‰´ìŠ¤ ë¶„ì„</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page.css">
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">ì˜¤ë¥´ë‹¤</div>
                <div class="logo-subtitle">íˆ¬ì í•™ìŠµ í”Œë«í¼</div>
            </div>
            <div class="nav-menu">
                <div class="nav-item" onclick="navigateTo('home')"><span class="nav-icon">ğŸ </span><span>Home</span></div>
                <div class="nav-item active" onclick="navigateTo('news')"><span class="nav-icon">ğŸ“°</span><span>News</span></div>
                <div class="nav-item" onclick="navigateTo('sector')"><span class="nav-icon">ğŸ­</span><span>Sector</span></div>
                <div class="nav-item" onclick="navigateTo('company')"><span class="nav-icon">ğŸ¢</span><span>Company</span></div>
                <div class="nav-item" onclick="navigateTo('mock-invest')"><span class="nav-icon">ğŸ“ˆ</span><span>Mock Invest</span></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page-header">
                <div class="breadcrumb">Home â†’ News</div>
                <h1 class="page-title">ğŸ“° ê³¼ê±° ë‰´ìŠ¤ ë¶„ì„</h1>
                <p class="page-subtitle" id="page-subtitle">ê³¼ê±° ì£¼ìš” íˆ¬ì ì´ìŠˆë“¤ì„ ê²€ìƒ‰í•˜ê³  AIë¡œ ë¶„ì„í•´ë³´ì„¸ìš”.</p>
            </div>
            
            <div class="search-filter-section">
                <div class="search-controls">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="news-search-input" class="search-input" placeholder="ì´ìŠˆëª…, í‚¤ì›Œë“œë¡œ ê³¼ê±° ì´ìŠˆ ê²€ìƒ‰...">
                    </div>
                </div>
            </div>
            
            <div class="news-section">
                <div class="section-header">
                    <h2 class="section-title" id="news-list-title">ê³¼ê±° ì´ìŠˆ ëª©ë¡</h2>
                </div>
                <div class="news-list" id="news-container"></div>
            </div>
        </div>
    </div>

    <div id="analysis-modal" class="modal-overlay"></div>

    <script>
        let allPastNews = [];
        let searchTimeout;

        document.addEventListener('DOMContentLoaded', () => {
            loadPastNews();
            setupEventListeners();
        });

        async function loadPastNews(searchTerm = '') {
            const container = document.getElementById('news-container');
            container.innerHTML = `<div class="loading"><div class="spinner"></div><p>ê³¼ê±° ì´ìŠˆ ë°ì´í„°ë¥¼ DBì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
            
            const apiUrl = `/api/database/past-issues?limit=100&search=${encodeURIComponent(searchTerm)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);

                const result = await response.json();
                if (!Array.isArray(result)) throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                
                allPastNews = result;
                displayNews(allPastNews);
                
                document.getElementById('page-subtitle').textContent = `ì´ ${allPastNews.length}ê°œì˜ ê³¼ê±° ì´ìŠˆë¥¼ DBì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;

            } catch (error) {
                console.error('âŒ ê³¼ê±° ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `<div class="loading"><p class="error-text">${error.message}</p></div>`;
                showNotification('ê³¼ê±° ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function displayNews(news) {
            const container = document.getElementById('news-container');
            container.innerHTML = '';

            if (news.length === 0) {
                container.innerHTML = `<div class="loading"><p>í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ê³¼ê±° ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                return;
            }
            news.forEach(item => container.appendChild(createNewsListItem(item)));
        }

        function createNewsListItem(news) {
            const item = document.createElement('div');
            item.className = 'news-item';
            
            item.innerHTML = `
                <div class="news-content">
                    <div class="news-meta">
                        <div class="news-date">${news.start_date || 'ë‚ ì§œ ë¯¸ìƒ'}</div>
                        <div class="news-source">ê³¼ê±° ì´ìŠˆ DB</div>
                        ${news.related_industries ? `<div class="impact-tag">${news.related_industries.split(',')[0].trim()}</div>` : ''}
                    </div>
                    <h3 class="news-title">${news.issue_name}</h3>
                    <p class="news-summary">${(news.contents || '').substring(0, 150)}...</p>
                    <div class="news-actions">
                        <button class="action-btn btn-analyze" onclick="analyzeNews(event, '${news.id}')">ğŸ¤– AI ì‹¬ì¸µ ë¶„ì„</button>
                    </div>
                </div>
            `;
            return item;
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('news-search-input');
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadPastNews(e.target.value);
                }, 500);
            });
        }

        async function analyzeNews(event, newsId) {
            event.stopPropagation();
            const newsItem = allPastNews.find(n => n.id === newsId);
            if (!newsItem) return;

            const modal = document.getElementById('analysis-modal');
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content loading"><div class="spinner"></div><p>RAG ë¶„ì„ì„ ìš”ì²­í•˜ëŠ” ì¤‘...</p></div>`;
            showNotification(`'${newsItem.issue_name}'ì— ëŒ€í•œ RAG ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');

            try {
                const response = await fetch('/api/analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content: newsItem.issue_name + "\n" + newsItem.contents })
                });

                if (!response.ok) throw new Error('ë¶„ì„ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                const result = await response.json();
                modal.innerHTML = createAnalysisModalContent(newsItem, result);

            } catch (error) {
                console.error('âŒ RAG ë¶„ì„ ì‹¤íŒ¨:', error);
                modal.innerHTML = `<div class="modal-content"><p class="error-text">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p><button class="btn" onclick="closeModal()">ë‹«ê¸°</button></div>`;
            }
        }

        function createAnalysisModalContent(originalNews, analysisResult) {
            return `
                <div class="modal-content">
                    <button onclick="closeModal()" class="modal-close-btn">&times;</button>
                    <h2 class="modal-title">RAG ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼</h2>
                    <div class="modal-text-box" style="margin-bottom:1.5rem;"><strong>ì›ë³¸ ì´ìŠˆ:</strong> ${originalNews.issue_name}</div>
                    <div class="modal-section">
                        <h3 class="modal-section-title green">ğŸ’¡ ì¢…í•© ë¶„ì„ (ì‹ ë¢°ë„: ${(analysisResult.confidence || 0).toFixed(2)})</h3>
                        <div class="modal-highlight-box green">${analysisResult.explanation.replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="modal-grid">
                        <div class="modal-section">
                            <h3 class="modal-section-title red">ğŸ­ ê´€ë ¨ ì‚°ì—…</h3>
                            <div class="modal-highlight-box red scrollable">${formatContextForModal(analysisResult.industries, 'ì‚°ì—…')}</div>
                        </div>
                        <div class="modal-section">
                            <h3 class="modal-section-title blue">ğŸ“š ìœ ì‚¬ ê³¼ê±° ì´ìŠˆ</h3>
                            <div class="modal-highlight-box blue scrollable">${formatContextForModal(analysisResult.past_issues, 'ê³¼ê±° ì´ìŠˆ')}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('analysis-modal').style.display = 'none';
        }

        function formatContextForModal(items, type) {
            if (!items || items.length === 0) return `<div class="modal-no-data">ê´€ë ¨ ${type} ì •ë³´ ì—†ìŒ</div>`;
            return items.map(item => `
                <div class="modal-list-item">
                    <div class="modal-list-title">${item.industry_name || item.issue_name}</div>
                    <p class="modal-list-desc">${(item.description || item.contents || '').substring(0, 150)}...</p>
                </div>
            `).join('');
        }
        
        function navigateTo(page) {
            const pages = {
                'home': '/static/index.html', 'news': '/static/news.html', 
                'sector': '/static/sector.html', 'company': '/static/company.html', 'mock-invest': '/static/mock-invest.html'
            };
            if (window.location.pathname !== pages[page]) {
                window.location.href = pages[page];
            }
        }

        function showNotification(message, type = 'info') {
             const colors = {
                success: 'linear-gradient(135deg, #28a745, #218838)',
                error: 'linear-gradient(135deg, #dc3545, #c82333)',
                info: 'linear-gradient(135deg, #17a2b8, #138496)'
            };
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">&times;</button>`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 5000);
        }
    </script>
</body>
</html>